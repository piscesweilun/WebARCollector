<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR 圖卡收集遊戲</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe-master.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden; /* 隱藏滾動條 */
        }
        /* 左側縮圖容器 */
        #thumbnails-container {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }
        .thumbnail {
            width: 50px;
            height: 50px;
            border: 2px solid white;
            border-radius: 8px;
            opacity: 0.3; /* 預設半透明 */
            transition: opacity 0.3s;
        }
        /* 左上角 QR Code 容器 */
        #qrcode-container {
            position: absolute;
            left: 10px;
            top: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 20;
            display: none; /* 預設隱藏 */
        }
    </style>
</head>
<body>
    <div id="thumbnails-container">
        <img id="thumb-0" class="thumbnail" src="./characters/char1.png">
        <img id="thumb-1" class="thumbnail" src="./characters/char2.png">
        <img id="thumb-2" class="thumbnail" src="./characters/char3.png">
        <img id="thumb-3" class="thumbnail" src="./characters/char4.png">
        <img id="thumb-4" class="thumbnail" src="./characters/char5.png">
        <img id="thumb-5" class="thumbnail" src="./characters/char6.png">
        <img id="thumb-6" class="thumbnail" src="./characters/char7.png">
        <img id="thumb-7" class="thumbnail" src="./characters/char8.png">
    </div>
    <div id="qrcode-container"></div>

    <a-scene id="ar-scene" mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-assets>
            <img id="char1" src="./characters/char1.png">
            <img id="char2" src="./characters/char2.png">
            <img id="char3" src="./characters/char3.png">
            <img id="char4" src="./characters/char4.png">
            <img id="char5" src="./characters/char5.png">
            <img id="char6" src="./characters/char6.png">
            <img id="char7" src="./characters/char7.png">
            <img id="char8" src="./characters/char8.png">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-image class="character-image" src="#char1" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 1">
            <a-image class="character-image" src="#char2" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 2">
            <a-image class="character-image" src="#char3" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 3">
            <a-image class="character-image" src="#char4" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 4">
            <a-image class="character-image" src="#char5" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 5">
            <a-image class="character-image" src="#char6" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 6">
            <a-image class="character-image" src="#char7" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 7">
            <a-image class="character-image" src="#char8" position="0 0 0" height="1" width="1" rotation="0 0 0" visible="false"></a-image>
        </a-entity>
    </a-scene>

    <script>
        // 等待整個網頁文件載入完成
        document.addEventListener('DOMContentLoaded', () => {
            const sceneEl = document.querySelector('#ar-scene');
            const qrcodeContainer = document.getElementById('qrcode-container');
            
            // 遊戲狀態：用一個陣列來記錄8個角色是否已被收集
            const collectionState = [false, false, false, false, false, false, false, false];
            const totalCharacters = 8;
            let collectedCount = 0;

            // 取得所有圖卡目標實體
            const characterEntities = document.querySelectorAll('[mindar-image-target]');

            // 為每個圖卡目標新增事件監聽器
            characterEntities.forEach((entity, index) => {
                const characterImage = entity.querySelector('.character-image');

                // 當圖卡被偵測到 (進入畫面)
                entity.addEventListener('targetFound', event => {
                    // 顯示對應的角色圖片
                    characterImage.setAttribute('visible', 'true');
                    
                    // 檢查是否為第一次收集
                    if (!collectionState[index]) {
                        console.log(`收集到角色 #${index + 1}`);
                        collectionState[index] = true;
                        collectedCount++;

                        // 更新左側縮圖的樣式
                        document.getElementById(`thumb-${index}`).style.opacity = '1';

                        // 檢查是否已全部收集完畢
                        checkIfComplete();
                    }
                });

                // 當圖卡離開畫面
                entity.addEventListener('targetLost', event => {
                    // 隱藏角色圖片
                    characterImage.setAttribute('visible', 'false');
                });
            });

            // 檢查是否集滿所有角色
            function checkIfComplete() {
                if (collectedCount === totalCharacters) {
                    console.log('恭喜！已收集所有角色！');
                    generateAndShowQRCode();
                }
            }

            // 生成並顯示 QR Code
            function generateAndShowQRCode() {
                // 1. 準備資料
                const now = new Date();
                const date = now.toISOString().split('T')[0]; // YYYY-MM-DD
                const time = now.toTimeString().split(' ')[0]; // HH:MM:SS
                const randomCode = Math.floor(100000 + Math.random() * 900000).toString(); // 6位數隨機碼

                const jsonData = {
                    date: date,
                    time: time,
                    code: randomCode,
                };
                const jsonString = JSON.stringify(jsonData);

                // 2. 清空容器並生成新的 QR Code
                qrcodeContainer.innerHTML = '';
                new QRCode(qrcodeContainer, {
                    text: jsonString,
                    width: 100,
                    height: 100,
                });

                // 3. 顯示 QR Code 容器
                qrcodeContainer.style.display = 'block';
            }
        });
    </script>
</body>
</html>